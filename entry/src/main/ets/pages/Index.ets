  // å…¬å†è½¬å†œå†ç®—æ³•
interface LunarDateResult {
  lunarYear: number;
  lunarMonth: number;
  lunarDay: number;
  isLeap: boolean;
}

interface CalendarEvent {
  id: string;
  title: string;
  description?: string;
  startTime: Date;
  endTime: Date;
  allDay: boolean;
  source?: string; // local / imported / subscription
  reminderMinutes?: number; // æå‰å¤šå°‘åˆ†é’Ÿæé†’ï¼Œ0è¡¨ç¤ºä¸æé†’
  reminded?: boolean; // æ˜¯å¦å·²ç»æé†’è¿‡
}

interface SubscriptionSource {
  id: string;
  name: string;
  url: string;
  lastSync?: Date;
}

@Entry
@Component
struct Index {
  @State currentDate: Date = new Date();
  @State currentView: string = 'month'; // 'month' | 'week' | 'day'
  @State events: CalendarEvent[] = [];
  @State showEditor: boolean = false;
  @State editingTitle: string = '';
  @State editingDescription: string = '';
  @State editingAllDay: boolean = false;
  @State editingStartHour: number = 9;
  @State editingEndHour: number = 10;
  @State editingStartMinute: number = 0;
  @State editingEndMinute: number = 0;
  @State editorError: string = '';
  @State showExportDialog: boolean = false;
  @State exportedIcs: string = '';
  @State showImportDialog: boolean = false;
  @State icsImportText: string = '';
  @State showTopMenu: boolean = false;
  @State showJumpDialog: boolean = false;
  @State jumpYear: number = 2025;
  @State jumpMonth: number = 1;
  @State jumpDay: number = 1;
  @State editingEventId: string = ''; // ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºæ–°å¢ï¼Œéç©ºè¡¨ç¤ºç¼–è¾‘
  @State editingReminderMinutes: number = 0; // æé†’æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
  @State showSubscriptionDialog: boolean = false;
  @State subscriptionUrl: string = '';
  @State subscriptionName: string = '';
  @State subscriptions: SubscriptionSource[] = [];
  @State reminderCheckInterval: number = 0;

  private weekDays: string[] = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
  private monthRows: number[] = [0, 1, 2, 3, 4, 5];
  private monthCols: number[] = [0, 1, 2, 3, 4, 5, 6];
  private weekIndices: number[] = [0, 1, 2, 3, 4, 5, 6];

  aboutToAppear() {
    this.startReminderCheck();
  }

  aboutToDisappear() {
    // æ¸…ç†å®šæ—¶å™¨
    if (this.reminderCheckInterval !== 0) {
      clearInterval(this.reminderCheckInterval);
    }
  }

  private startReminderCheck(): void {
    this.reminderCheckInterval = setInterval(() => {
      this.checkReminders();
    }, 10000); // æ¯10ç§’æ£€æŸ¥
    // ç«‹å³æ£€æŸ¥ä¸€æ¬¡
    this.checkReminders();
  }

  @State reminderMessage: string = '';
  @State showReminderAlert: boolean = false;

  private checkReminders() {
    // è·å–å½“å‰è®¾å¤‡æ—¶é—´ï¼ˆå¦‚æœæ˜¯æ¨¡æ‹Ÿå™¨è¿è¡Œï¼Œåˆ™ä¸ºæ¨¡æ‹Ÿå™¨æ—¶é—´ï¼‰
    const now: Date = new Date();
    const nowTime: number = now.getTime();

    for (let i: number = 0; i < this.events.length; i++) {
      const event: CalendarEvent = this.events[i];
      if (event.reminded || !event.reminderMinutes || event.reminderMinutes <= 0) {
        continue;
      }

      const eventTime: number = event.startTime.getTime();
      const reminderTime: number = eventTime - event.reminderMinutes * 60 * 1000;

      // å¦‚æœå½“å‰æ—¶é—´åœ¨æé†’æ—¶é—´ä¹‹åï¼Œä¸”åœ¨äº‹ä»¶å¼€å§‹æ—¶é—´ä¹‹å‰
      if (nowTime >= reminderTime && nowTime < eventTime) {
        // è§¦å‘æé†’
        this.reminderMessage = `ã€${event.title}ã€‘å°†åœ¨${event.reminderMinutes}åˆ†é’Ÿåå¼€å§‹`;
        this.showReminderAlert = true;

        // æ ‡è®°ä¸ºå·²æé†’
        const index = this.events.findIndex(e => e.id === event.id);
        if (index !== -1) {
          const original = this.events[index];
          const updated: CalendarEvent = {
            id: original.id,
            title: original.title,
            description: original.description,
            startTime: original.startTime,
            endTime: original.endTime,
            allDay: original.allDay,
            source: original.source,
            reminderMinutes: original.reminderMinutes,
            reminded: true
          };
          // ä½¿ç”¨æ–°æ•°ç»„å¼ºåˆ¶åˆ·æ–°çŠ¶æ€
          const newEvents = [...this.events];
          newEvents[index] = updated;
          this.events = newEvents;
        }
        break;
      }
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨ä¸€è¡Œï¼šå·¦è¾¹ä»Šå¤©æŒ‰é’®ï¼Œä¸­é—´å·¦å³åˆ‡æœˆ + å½“å‰æœˆä»½ï¼ˆ2025.12ï¼‰ï¼Œå³è¾¹èœå•
      Row() {
        // ä»Šå¤©ï¼ˆæ–‡å­—æŒ‰é’®ï¼‰
        Text('ä»Šå¤©')
          .fontSize(13)
          .fontColor('#2563EB')
          .padding({ right: 8 })
          .onClick(() => {
            this.currentDate = new Date();
          })

        Blank()

        // ä¸­é—´ï¼šå·¦å³åˆ‡æœˆ + å½“å‰æœˆä»½
        Row() {
          Text('<')
            .fontSize(18)
            .fontColor('#4B5563')
            .padding({ left: 4, right: 8 })
            .onClick(() => {
              this.shiftMonth(-1);
            })

          Text(this.getHeaderSubtitle())
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#111827')
            .margin({ left: 4, right: 4 })

          Text('>')
            .fontSize(18)
            .fontColor('#4B5563')
            .padding({ left: 8, right: 4 })
            .onClick(() => {
              this.shiftMonth(1);
            })
        }
        .justifyContent(FlexAlign.Center)
        .alignItems(VerticalAlign.Center)

        Blank()

        // é¡¶éƒ¨æ›´å¤šèœå•ï¼ˆç«–ç€çš„ä¸¤ä¸ªç‚¹å›¾æ ‡ï¼‰
        Text('â‹®')
          .fontSize(18)
          .fontColor('#6B7280')
          .padding({ left: 12 })
          .onClick(() => {
            this.showTopMenu = true;
          })
      }
      .padding({ left: 16, right: 16, top: 8, bottom: 4 })
      .backgroundColor(Color.White)

      // è§†å›¾åˆ‡æ¢ Tabï¼ˆç»†é•¿ä¸€è¡Œï¼‰
      Row() {
        this.renderTab('month', 'æœˆ');
        this.renderTab('week', 'å‘¨');
        this.renderTab('day', 'æ—¥');
      }
      .margin({ top: 4, left: 16, right: 16, bottom: 4 })

      // æ—¥å†ä¸»ä½“åŒºåŸŸ
      Column() {
        // æ˜ŸæœŸæ 
        Row() {
          ForEach(this.weekDays, (day: string) => {
            Text(day)
              .fontSize(12)
              .fontColor('#9AA4B2')
              .textAlign(TextAlign.Center)
              .width('14.28%');
          }, (day: string) => day)
        }
        .margin({ top: 8, bottom: 8 })

        // æœˆè§†å›¾ç½‘æ ¼éª¨æ¶
        if (this.currentView === 'month') {
          Column() {
            ForEach(this.monthRows, (rowIndex: number) => {
              Row() {
                ForEach(this.monthCols, (colIndex: number) => {
                  Column() {
                    // æ—¥æœŸæ•°å­—
                    Text(`${this.getMonthCellDate(rowIndex, colIndex).getDate()}`)
                      .fontSize(14)
                      .fontColor(
                        this.isCellInCurrentMonth(rowIndex, colIndex)
                          ? (this.isCellToday(rowIndex, colIndex)
                            ? Color.White
                            : (this.isSameDate(this.getMonthCellDate(rowIndex, colIndex), this.currentDate)
                              ? '#1D4ED8'
                              : '#111827'))
                          : '#D1D5DB')
                      .textAlign(TextAlign.Center)
                      .width('100%');

                    // å†œå†å°å­—ï¼ˆç®€åŒ–ç‰ˆï¼‰
                    Text(this.getLunarLabel(this.getMonthCellDate(rowIndex, colIndex)))
                      .fontSize(9)
                      .fontColor(this.isCellToday(rowIndex, colIndex) ? '#E5E7EB' : '#9CA3AF')
                      .margin({ top: 1 })

                    // äº‹ä»¶å°åœ†ç‚¹ï¼ˆæœ€å¤š2ä¸ªï¼Œçºµå‘ï¼‰
                    Column() {
                      ForEach(this.getEventDotArray(this.getMonthCellDate(rowIndex, colIndex)), (dotIndex: number) => {
                        Row()
                          .width(4)
                          .height(4)
                          .backgroundColor(this.isCellToday(rowIndex, colIndex) ? Color.White : '#3B82F6')
                          .borderRadius(2)
                          .margin({ top: dotIndex === 0 ? 1 : 2 })
                      }, (dotIndex: number) => `${rowIndex}-${colIndex}-dot-${dotIndex}`)
                    }
                    .justifyContent(FlexAlign.Center)
                    .alignItems(HorizontalAlign.Center)
                  }
                  .width('14.28%')
                  .height(52)
                  .borderRadius(12)
                  .backgroundColor(
                    this.isCellToday(rowIndex, colIndex) && this.isCellInCurrentMonth(rowIndex, colIndex)
                      ? '#4C6FFF'
                      : (this.isSameDate(this.getMonthCellDate(rowIndex, colIndex), this.currentDate)
                        && this.isCellInCurrentMonth(rowIndex, colIndex)
                        ? '#DBEAFE'
                        : 'transparent')
                  )
                  .justifyContent(FlexAlign.Center)
                  .alignItems(HorizontalAlign.Center)
                  .onClick(() => {
                    this.currentDate = this.getMonthCellDate(rowIndex, colIndex);
                  })
                }, (colIndex: number) => `${rowIndex}-${colIndex}`)
              }
              .margin({ top: 4, bottom: 4 })
            }, (rowIndex: number) => `${rowIndex}`)
          }
        }
      }
      .margin({ left: 16, right: 16, bottom: 8 })

      // å‘¨è§†å›¾å’Œæ—¥è§†å›¾ï¼ˆå¯æ»šåŠ¨ï¼‰
      if (this.currentView === 'week') {
        this.buildWeekView();
      } else if (this.currentView === 'day') {
        this.buildDayView();
      }

      // æœˆè§†å›¾ä¸‹æ–¹ï¼šé€‰ä¸­æ—¥æœŸçš„æ—¥ç¨‹åˆ—è¡¨ï¼ˆå¯æ»šåŠ¨ï¼‰
      if (this.currentView === 'month') {
        Scroll() {
          Column() {
            if (this.getEventsForDate(this.currentDate).length === 0) {
              Text('è¿™ä¸€å¤©æ²¡æœ‰å®‰æ’æ—¥ç¨‹')
                .fontSize(13)
                .fontColor('#6B7280')
                .margin({ top: 16 })
            } else {
              ForEach(this.getEventsForDate(this.currentDate), (event: CalendarEvent) => {
                Row() {
                  // å·¦ä¾§æ—¶é—´
                  Text(this.formatTimeRange(event))
                    .fontSize(13)
                    .fontColor('#6B7280')
                    .width(90)

                  // å³ä¾§äº‹ä»¶ä¿¡æ¯
                  Column() {
                    Text(event.title)
                      .fontSize(14)
                      .fontWeight(FontWeight.Medium)
                      .fontColor('#111827')
                      .maxLines(1)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                      .width('100%')

                    if (event.description) {
                      Text(event.description)
                        .fontSize(12)
                        .fontColor('#6B7280')
                        .margin({ top: 2 })
                        .maxLines(1)
                        .textOverflow({ overflow: TextOverflow.Ellipsis })
                        .width('100%')
                    }
                  }
                  .layoutWeight(1)
                  .alignItems(HorizontalAlign.Start)
                }
                .width('100%')
                .padding({ left: 12, right: 12, top: 10, bottom: 10 })
                .backgroundColor(Color.White)
                .borderRadius(10)
                .margin({ bottom: 8 })
                .onClick(() => {
                  this.openEditEventEditor(event);
                })
              }, (event: CalendarEvent) => `month-${event.id}-${event.title}-${event.startTime.getTime()}`)
            }
          }
          .width('100%')
          .alignItems(HorizontalAlign.Start)
        }
        .layoutWeight(1)
        .padding({ left: 16, right: 16 })
        .scrollBar(BarState.Off)
        .align(Alignment.TopStart)
      }

      // æµ®åŠ¨æ·»åŠ æŒ‰é’®
      Row() {
        Blank();
        Button('+')
          .type(ButtonType.Circle)
          .width(56)
          .height(56)
          .fontSize(28)
          .backgroundColor('#4C6FFF')
          .fontColor(Color.White)
          .shadow({
            radius: 20,
            color: 'rgba(76, 111, 255, 0.6)',
            offsetX: 0,
            offsetY: 10
          })
          .onClick(() => {
            this.openNewEventEditor();
          })
      }
      .margin({ right: 24, bottom: 36 })
      .alignItems(VerticalAlign.Bottom)

      // ç®€å•äº‹ä»¶ç¼–è¾‘å¼¹å±‚
      if (this.showEditor) {
        Column() {
          Column() {
            Text(this.editingEventId !== '' ? 'ç¼–è¾‘æ—¥ç¨‹' : 'æ–°å¢æ—¥ç¨‹')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#111827')
              .margin({ bottom: 12 })

            Scroll() {
              Column() {
                // æ ‡é¢˜
                Text('æ ‡é¢˜')
                  .fontSize(13)
                  .fontColor('#6B7280')
                TextInput({ text: this.editingTitle, placeholder: 'ä¾‹å¦‚ï¼šå’ŒåŒå­¦èšé¤' })
                  .onChange((value: string) => {
                    this.editingTitle = value;
                  })
                  .margin({ bottom: 8 })

                // æè¿°
                Text('å¤‡æ³¨')
                  .fontSize(13)
                  .fontColor('#6B7280')
                TextInput({ text: this.editingDescription, placeholder: 'å¯é€‰ï¼Œä¾‹å¦‚ï¼šåœ°ç‚¹ã€å†…å®¹ç­‰' })
                  .onChange((value: string) => {
                    this.editingDescription = value;
                  })
                  .margin({ bottom: 8 })

                // å…¨å¤©å¼€å…³
                Row() {
                  Text('å…¨å¤©')
                    .fontSize(13)
                    .fontColor('#4B5563')
                  Blank()
                  Toggle({ type: ToggleType.Switch, isOn: this.editingAllDay })
                    .onChange((value: boolean) => {
                      this.editingAllDay = value;
                    })
                }
                .margin({ top: 4, bottom: 8 })

                // æ—¶é—´ï¼ˆä½¿ç”¨æ—¶åˆ†æ»‘åŠ¨é€‰æ‹©å™¨ï¼‰
                if (!this.editingAllDay) {
                  Column() {
                    Text('å¼€å§‹æ—¶é—´')
                      .fontSize(13)
                      .fontColor('#4B5563')
                      .margin({ bottom: 4 })

                    TimePicker({
                      selected: new Date(0, 0, 1, this.editingStartHour, this.editingStartMinute, 0)
                    })
                      .onChange((value) => {
                        this.editingStartHour = value.hour;
                        this.editingStartMinute = value.minute;
                      })

                    Blank().height(8)

                    Text('ç»“æŸæ—¶é—´')
                      .fontSize(13)
                      .fontColor('#4B5563')
                      .margin({ bottom: 4 })

                    TimePicker({
                      selected: new Date(0, 0, 1, this.editingEndHour, this.editingEndMinute, 0)
                    })
                      .onChange((value) => {
                        this.editingEndHour = value.hour;
                        this.editingEndMinute = value.minute;
                      })
                  }
                }

                // æé†’è®¾ç½®
                Row() {
                  Text('æå‰æé†’')
                    .fontSize(13)
                    .fontColor('#4B5563')
                  Blank()
                  Select([
                    { value: 'ä¸æé†’' },
                    { value: '5åˆ†é’Ÿ' },
                    { value: '15åˆ†é’Ÿ' },
                    { value: '30åˆ†é’Ÿ' },
                    { value: '1å°æ—¶' }
                  ])
                    .selected(this.getReminderSelectIndex())
                    .value(this.getReminderSelectValue())
                    .onSelect((index: number) => {
                      const values: number[] = [0, 5, 15, 30, 60];
                      this.editingReminderMinutes = values[index];
                    })
                }
                .margin({ top: 8, bottom: 8 })

                // æ ¡éªŒé”™è¯¯æç¤º
                if (this.editorError && this.editorError !== '') {
                  Text(this.editorError)
                    .fontSize(12)
                    .fontColor('#DC2626')
                    .margin({ top: 6 })
                }
              }
            }
            .height('50vh')
            .scrollBar(BarState.Auto)

            // æŒ‰é’®è¡Œ
            Row() {
              if (this.editingEventId !== '') {
                Button('åˆ é™¤')
                  .backgroundColor('#FEE2E2')
                  .fontColor('#DC2626')
                  .margin({ right: 8 })
                  .onClick(() => {
                    this.deleteEvent(this.editingEventId);
                    this.showEditor = false;
                  })
              }

              Button('å–æ¶ˆ')
                .backgroundColor('#E5E7EB')
                .fontColor('#374151')
                .margin({ right: 8 })
                .onClick(() => {
                  this.showEditor = false;
                })

              Button('ä¿å­˜')
                .backgroundColor('#2563EB')
                .fontColor(Color.White)
                .onClick(() => {
                  this.saveNewEvent();
                })
            }
            .margin({ top: 16, bottom: 8 })
          }
          .backgroundColor(Color.White)
          .borderRadius(16)
          .padding({ left: 20, right: 20, top: 28, bottom: 28 })
          .width('90%')
          .constraintSize({ maxHeight: '80%' })
        }
        .height('100%')
        .width('100%')
        .backgroundColor('rgba(0,0,0,0.4)')
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.showEditor = false;
        })
        .position({ x: 0, y: 0 })
      }

      // é¡¶éƒ¨æ›´å¤šèœå•å¼¹å±‚
      if (this.showTopMenu) {
        Column() {
          Column() {
            Text('èœå•')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#111827')
              .margin({ bottom: 12 })

            Row() {
              Text('ğŸ“…')
                .fontSize(16)
                .margin({ right: 12 })
              Text('è·³è½¬åˆ°æ—¥æœŸ')
                .fontSize(14)
                .fontColor('#374151')
            }
            .width('100%')
            .padding({ top: 12, bottom: 12 })
            .onClick(() => {
              this.showTopMenu = false;
              this.showJumpDialog = true;
            })

            Divider().color('#E5E7EB')

            Row() {
              Text('ğŸ ')
                .fontSize(16)
                .margin({ right: 12 })
              Text('å›åˆ°ä»Šå¤©')
                .fontSize(14)
                .fontColor('#374151')
            }
            .width('100%')
            .padding({ top: 12, bottom: 12 })
            .onClick(() => {
              this.currentDate = new Date();
              this.showTopMenu = false;
            })

            Divider().color('#E5E7EB')

            Row() {
              Text('ğŸ“¤')
                .fontSize(16)
                .margin({ right: 12 })
              Text('å¯¼å‡ºæ—¥ç¨‹')
                .fontSize(14)
                .fontColor('#374151')
            }
            .width('100%')
            .padding({ top: 12, bottom: 12 })
            .onClick(() => {
              this.exportedIcs = this.exportEventsToIcs();
              this.showTopMenu = false;
              this.showExportDialog = true;
            })

            Divider().color('#E5E7EB')

            Row() {
              Text('ğŸ“¥')
                .fontSize(16)
                .margin({ right: 12 })
              Text('å¯¼å…¥æ—¥ç¨‹')
                .fontSize(14)
                .fontColor('#374151')
            }
            .width('100%')
            .padding({ top: 12, bottom: 12 })
            .onClick(() => {
              this.icsImportText = '';
              this.showTopMenu = false;
              this.showImportDialog = true;
            })

            Divider().color('#E5E7EB')

            Row() {
              Text('ğŸŒ')
                .fontSize(16)
                .margin({ right: 12 })
              Text('ç½‘ç»œè®¢é˜…')
                .fontSize(14)
                .fontColor('#374151')
            }
            .width('100%')
            .padding({ top: 12, bottom: 12 })
            .onClick(() => {
              this.subscriptionUrl = '';
              this.subscriptionName = '';
              this.showTopMenu = false;
              this.showSubscriptionDialog = true;
            })
          }
          .backgroundColor(Color.White)
          .borderRadius(16)
          .padding({ left: 20, right: 20, top: 20, bottom: 20 })
          .width('80%')
        }
        .height('100%')
        .width('100%')
        .backgroundColor('rgba(0,0,0,0.4)')
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.showTopMenu = false;
        })
        .position({ x: 0, y: 0 })
      }

      // è·³è½¬æ—¥æœŸå¼¹å±‚
      if (this.showJumpDialog) {
        Column() {
          Column() {
            Text('è·³è½¬åˆ°æŒ‡å®šæ—¥æœŸ')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#111827')
              .margin({ bottom: 16 })

            DatePicker({
              start: new Date('1970-1-1'),
              end: new Date('2100-12-31'),
              selected: this.currentDate
            })
              .onDateChange((value: Date) => {
                this.jumpYear = value.getFullYear();
                this.jumpMonth = value.getMonth() + 1;
                this.jumpDay = value.getDate();
              })

            Row() {
              Button('å–æ¶ˆ')
                .backgroundColor('#E5E7EB')
                .fontColor('#374151')
                .margin({ right: 8 })
                .onClick(() => {
                  this.showJumpDialog = false;
                })

              Button('è·³è½¬')
                .backgroundColor('#2563EB')
                .fontColor(Color.White)
                .onClick(() => {
                  this.currentDate = new Date(this.jumpYear, this.jumpMonth - 1, this.jumpDay);
                  this.showJumpDialog = false;
                })
            }
            .margin({ top: 16 })
          }
          .backgroundColor(Color.White)
          .borderRadius(16)
          .padding({ left: 20, right: 20, top: 20, bottom: 20 })
          .width('85%')
        }
        .height('100%')
        .width('100%')
        .backgroundColor('rgba(0,0,0,0.4)')
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.showJumpDialog = false;
        })
        .position({ x: 0, y: 0 })
      }

      // å¯¼å‡ºå¼¹å±‚
      if (this.showExportDialog) {
        Column() {
          Column() {
            Text('å¯¼å‡ºæ—¥ç¨‹ (ICSæ ¼å¼)')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#111827')
              .margin({ bottom: 12 })

            Text('é•¿æŒ‰ä¸‹æ–¹æ–‡æœ¬æ¡†å¯å…¨é€‰å¤åˆ¶ï¼Œç„¶åä¿å­˜ä¸º .ics æ–‡ä»¶')
              .fontSize(13)
              .fontColor('#6B7280')
              .margin({ bottom: 8 })

            TextArea({ text: this.exportedIcs })
              .fontSize(11)
              .fontColor('#374151')
              .backgroundColor('#F3F4F6')
              .padding(8)
              .borderRadius(4)
              .height(200)
              .width('100%')

            Button('å…³é—­')
              .backgroundColor('#2563EB')
              .fontColor(Color.White)
              .margin({ top: 16 })
              .onClick(() => {
                this.showExportDialog = false;
              })
          }
          .backgroundColor(Color.White)
          .borderRadius(16)
          .padding({ left: 20, right: 20, top: 20, bottom: 20 })
          .width('85%')
        }
        .height('100%')
        .width('100%')
        .backgroundColor('rgba(0,0,0,0.4)')
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.showExportDialog = false;
        })
        .position({ x: 0, y: 0 })
      }

      // å¯¼å…¥å¼¹å±‚
      if (this.showImportDialog) {
        Column() {
          Column() {
            Text('å¯¼å…¥æ—¥ç¨‹ (ICSæ ¼å¼)')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#111827')
              .margin({ bottom: 12 })

            Text('ç²˜è´´ICSå†…å®¹ï¼Œæˆ–ç‚¹å‡»â€œå¡«å……ç¤ºä¾‹â€æµ‹è¯•ï¼š')
              .fontSize(13)
              .fontColor('#6B7280')
              .margin({ bottom: 8 })

            TextArea({ text: this.icsImportText, placeholder: 'BEGIN:VCALENDAR\nVERSION:2.0\n...' })
              .height(150)
              .onChange((value: string) => {
                this.icsImportText = value;
              })

            Row() {
              Button('å¡«å……ç¤ºä¾‹')
                .backgroundColor('#F3F4F6')
                .fontColor('#374151')
                .margin({ right: 8 })
                .onClick(() => {
                  this.icsImportText = 'BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nUID:import-test-001\nSUMMARY:å¯¼å…¥æµ‹è¯•äº‹ä»¶\nDESCRIPTION:è¿™æ˜¯ä¸€ä¸ªå¯¼å…¥çš„æµ‹è¯•æ—¥ç¨‹\nDTSTART:20251216T140000\nDTEND:20251216T150000\nEND:VEVENT\nEND:VCALENDAR';
                })

              Button('å–æ¶ˆ')
                .backgroundColor('#E5E7EB')
                .fontColor('#374151')
                .margin({ right: 8 })
                .onClick(() => {
                  this.showImportDialog = false;
                })

              Button('å¯¼å…¥')
                .backgroundColor('#2563EB')
                .fontColor(Color.White)
                .onClick(() => {
                  const beforeCount: number = this.events.length;
                  this.importEventsFromIcs(this.icsImportText);
                  const afterCount: number = this.events.length;
                  const importedCount: number = afterCount - beforeCount;
                  if (importedCount > 0) {
                    this.reminderMessage = `æˆåŠŸå¯¼å…¥ ${importedCount} ä¸ªæ—¥ç¨‹`;
                    this.showReminderAlert = true;
                  }
                  this.showImportDialog = false;
                })
            }
            .margin({ top: 16 })
          }
          .backgroundColor(Color.White)
          .borderRadius(16)
          .padding({ left: 20, right: 20, top: 20, bottom: 20 })
          .width('85%')
        }
        .height('100%')
        .width('100%')
        .backgroundColor('rgba(0,0,0,0.4)')
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.showImportDialog = false;
        })
        .position({ x: 0, y: 0 })
      }

      // ç½‘ç»œè®¢é˜…å¼¹å±‚
      if (this.showSubscriptionDialog) {
        Column() {
          Column() {
            Text('ç½‘ç»œè®¢é˜…')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#111827')
              .margin({ bottom: 12 })

            Text('è®¢é˜…åç§°')
              .fontSize(13)
              .fontColor('#6B7280')
            TextInput({ text: this.subscriptionName, placeholder: 'ä¾‹å¦‚ï¼šèŠ‚å‡æ—¥æ—¥å†' })
              .onChange((value: string) => {
                this.subscriptionName = value;
              })
              .margin({ bottom: 8 })

            Text('è®¢é˜…åœ°å€ (ICS URL)')
              .fontSize(13)
              .fontColor('#6B7280')
            TextInput({ text: this.subscriptionUrl, placeholder: 'https://example.com/calendar.ics' })
              .onChange((value: string) => {
                this.subscriptionUrl = value;
              })
              .margin({ bottom: 8 })

            // å·²æœ‰è®¢é˜…åˆ—è¡¨
            if (this.subscriptions.length > 0) {
              Text('å·²è®¢é˜…åˆ—è¡¨ï¼š')
                .fontSize(13)
                .fontColor('#6B7280')
                .margin({ top: 8, bottom: 4 })

              ForEach(this.subscriptions, (sub: SubscriptionSource) => {
                Row() {
                  Text(sub.name)
                    .fontSize(13)
                    .fontColor('#111827')
                    .layoutWeight(1)

                  Text('åˆ é™¤')
                    .fontSize(12)
                    .fontColor('#DC2626')
                    .onClick(() => {
                      this.removeSubscription(sub.id);
                    })
                }
                .padding({ top: 4, bottom: 4 })
              }, (sub: SubscriptionSource) => sub.id)
            }

            Row() {
              Button('å–æ¶ˆ')
                .backgroundColor('#E5E7EB')
                .fontColor('#374151')
                .margin({ right: 8 })
                .onClick(() => {
                  this.showSubscriptionDialog = false;
                })

              Button('æ·»åŠ è®¢é˜…')
                .backgroundColor('#7C3AED')
                .fontColor(Color.White)
                .onClick(() => {
                  this.addSubscription();
                })
            }
            .margin({ top: 16 })
          }
          .backgroundColor(Color.White)
          .borderRadius(16)
          .padding({ left: 20, right: 20, top: 20, bottom: 20 })
          .width('85%')
        }
        .height('100%')
        .width('100%')
        .backgroundColor('rgba(0,0,0,0.4)')
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.showSubscriptionDialog = false;
        })
        .position({ x: 0, y: 0 })
      }

      // æé†’å¼¹çª—
      if (this.showReminderAlert) {
        Column() {
          Column() {
            // å›¾æ ‡ï¼ˆä»…æ—¥ç¨‹æé†’æ˜¾ç¤ºï¼‰
            if (this.reminderMessage.includes('å°†åœ¨')) {
              Text('â°')
                .fontSize(48)
                .margin({ bottom: 12 })
            }

            Text(this.reminderMessage.includes('å°†åœ¨') ? 'æ—¥ç¨‹æé†’' : 'æç¤º')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor('#111827')
              .margin({ bottom: 8 })

            Text(this.reminderMessage)
              .fontSize(16)
              .fontColor('#374151')
              .textAlign(TextAlign.Center)
              .margin({ bottom: 24 })

            Button('æˆ‘çŸ¥é“äº†')
              .width('100%')
              .height(44)
              .backgroundColor('#2563EB')
              .fontColor(Color.White)
              .fontSize(16)
              .onClick(() => {
                this.showReminderAlert = false;
              })
          }
          .backgroundColor(Color.White)
          .borderRadius(20)
          .padding({ left: 32, right: 32, top: 32, bottom: 24 })
          .width('80%')
          .alignItems(HorizontalAlign.Center)
        }
        .height('100%')
        .width('100%')
        .backgroundColor('rgba(0,0,0,0.4)')
        .justifyContent(FlexAlign.Center)
        .onClick(() => {
          this.showReminderAlert = false;
        })
        .position({ x: 0, y: 0 })
      }
    }
    .height('100%')
    .width('100%')
    .backgroundColor('#F3F4F6')
  }

  @Builder
  private renderTab(key: string, label: string) {
    Column() {
      Text(label)
        .fontSize(14)
        .fontWeight(this.currentView === key ? FontWeight.Medium : FontWeight.Normal)
        .fontColor(this.currentView === key ? '#111827' : '#6B7280')
        .padding({ bottom: 4 })

      if (this.currentView === key) {
        Row()
          .width('60%')
          .height(3)
          .backgroundColor('#4C6FFF')
          .borderRadius(2);
      }
    }
    .width('33.33%')
    .alignItems(HorizontalAlign.Center)
    .onClick(() => {
      this.currentView = key;
    })
  }

  private getHeaderSubtitle(): string {
    const year = this.currentDate.getFullYear();
    const month = this.currentDate.getMonth() + 1;
    return `${year}.${month}`;
  }

  private shiftMonth(offset: number) {
    const d = new Date(this.currentDate.getTime());
    d.setMonth(d.getMonth() + offset);
    this.currentDate = d;
  }

  private openNewEventEditor() {
    this.editingEventId = '';
    this.editingTitle = '';
    this.editingDescription = '';
    this.editingAllDay = false;
    this.editingStartHour = 9;
    this.editingEndHour = 10;
    this.editingStartMinute = 0;
    this.editingEndMinute = 0;
    this.editingReminderMinutes = 15;
    this.editorError = '';
    this.showEditor = true;
  }

  private openEditEventEditor(event: CalendarEvent) {
    this.editingEventId = event.id;
    this.editingTitle = event.title;
    this.editingDescription = event.description || '';
    this.editingAllDay = event.allDay;
    this.editingStartHour = event.startTime.getHours();
    this.editingStartMinute = event.startTime.getMinutes();
    this.editingEndHour = event.endTime.getHours();
    this.editingEndMinute = event.endTime.getMinutes();
    this.editingReminderMinutes = event.reminderMinutes || 0;
    this.editorError = '';
    this.showEditor = true;
  }

  private saveNewEvent() {
    this.editorError = '';

    // æ ‡é¢˜å¿…å¡«æ ¡éªŒ
    if (!this.editingTitle || this.editingTitle.trim() === '') {
      this.editorError = 'è¯·å¡«å†™æ—¥ç¨‹æ ‡é¢˜';
      return;
    }

    let base: Date = this.currentDate;
    // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œä½¿ç”¨åŸäº‹ä»¶çš„æ—¥æœŸï¼Œç¡®ä¿ä¿®æ”¹æ—¶é—´æ—¶ä¸ä¼šæ”¹å˜æ—¥æœŸ
    if (this.editingEventId !== '') {
      const originalEvent = this.events.find(e => e.id === this.editingEventId);
      if (originalEvent) {
        base = originalEvent.startTime;
      }
    }

    let startTime: Date;
    let endTime: Date;
    if (this.editingAllDay) {
      startTime = new Date(base.getFullYear(), base.getMonth(), base.getDate(), 0, 0);
      endTime = new Date(base.getFullYear(), base.getMonth(), base.getDate(), 23, 59);
    } else {
      const sh: number = this.editingStartHour;
      const sm: number = this.editingStartMinute;
      const eh: number = this.editingEndHour;
      const em: number = this.editingEndMinute;

      // ç»“æŸæ—¶é—´ä¸èƒ½æ—©äºæˆ–ç­‰äºå¼€å§‹æ—¶é—´
      const startTotal: number = sh * 60 + sm;
      const endTotal: number = eh * 60 + em;
      
      if (endTotal <= startTotal) {
        this.editorError = 'ç»“æŸæ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´';
        return;
      }

      startTime = new Date(base.getFullYear(), base.getMonth(), base.getDate(), sh, sm);
      endTime = new Date(base.getFullYear(), base.getMonth(), base.getDate(), eh, em);
    }

    if (this.editingEventId !== '') {
      // ç¼–è¾‘æ¨¡å¼ï¼šæ›´æ–°ç°æœ‰äº‹ä»¶
      const index = this.events.findIndex(e => e.id === this.editingEventId);
      if (index !== -1) {
        const original = this.events[index];
        const updated: CalendarEvent = {
          id: original.id,
          title: this.editingTitle,
          description: this.editingDescription,
          startTime: startTime,
          endTime: endTime,
          allDay: this.editingAllDay,
          source: original.source,
          reminderMinutes: this.editingReminderMinutes,
          reminded: false
        };
        
        // åˆ›å»ºæ–°æ•°ç»„ä»¥è§¦å‘çŠ¶æ€æ›´æ–°
        const newEvents = [...this.events];
        newEvents[index] = updated;
        this.events = newEvents;
      }
    } else {
      // æ–°å¢æ¨¡å¼
      const newEvent: CalendarEvent = {
        id: `${Date.now()}`,
        title: this.editingTitle,
        description: this.editingDescription,
        startTime: startTime,
        endTime: endTime,
        allDay: this.editingAllDay,
        reminderMinutes: this.editingReminderMinutes,
        reminded: false
      };
      this.events = [...this.events, newEvent];
    }
    this.showEditor = false;
  }

  private deleteEvent(id: string) {
    this.events = this.events.filter((e: CalendarEvent): boolean => e.id !== id);
  }

  private addSubscription() {
    if (!this.subscriptionName || this.subscriptionName.trim() === '') {
      return;
    }
    if (!this.subscriptionUrl || this.subscriptionUrl.trim() === '') {
      return;
    }

    const newSub: SubscriptionSource = {
      id: `sub-${Date.now()}`,
      name: this.subscriptionName,
      url: this.subscriptionUrl,
      lastSync: new Date()
    };

    this.subscriptions = this.subscriptions.concat([newSub]);
    this.fetchSubscription(newSub);
    this.subscriptionName = '';
    this.subscriptionUrl = '';
  }

  private removeSubscription(id: string) {
    // åˆ é™¤è®¢é˜…æº
    this.subscriptions = this.subscriptions.filter((s: SubscriptionSource): boolean => s.id !== id);
    // åˆ é™¤è¯¥è®¢é˜…æºçš„æ‰€æœ‰äº‹ä»¶
    this.events = this.events.filter((e: CalendarEvent): boolean => e.source !== id);
  }

  private fetchSubscription(sub: SubscriptionSource): void {
    // ç½‘ç»œè®¢é˜…åŠŸèƒ½ï¼šæ¨¡æ‹Ÿè·å–è¿œç¨‹ICSæ–‡ä»¶
    // æ³¨æ„ï¼šHarmonyOSä¸­éœ€è¦ä½¿ç”¨@ohos.net.httpæ¨¡å—
    // è¿™é‡Œæä¾›ç¤ºä¾‹æ•°æ®ä»¥æ¼”ç¤ºåŠŸèƒ½
    const sampleIcs: string = `BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
UID:sample-${sub.id}
SUMMARY:è®¢é˜…æ—¥ç¨‹-${sub.name}
DTSTART:20251220T100000
DTEND:20251220T110000
DESCRIPTION:æ¥è‡ªè®¢é˜…æºçš„ç¤ºä¾‹æ—¥ç¨‹
END:VEVENT
END:VCALENDAR`;
    
    // è§£æç¤ºä¾‹æ•°æ®
    this.parseSubscriptionIcs(sampleIcs, sub.id);
  }

  private parseSubscriptionIcs(text: string, sourceId: string) {
    if (!text || text.trim() === '') {
      return;
    }
    const lines: string[] = text.split('\n');
    let cursor: number = 0;
    let imported: CalendarEvent[] = [];

    while (cursor < lines.length) {
      const line: string = lines[cursor].trim();
      if (line === 'BEGIN:VEVENT') {
        let id: string = `${sourceId}-${Date.now()}-${cursor}`;
        let title: string = '';
        let description: string = '';
        let dtStart: Date = new Date();
        let dtEnd: Date = new Date();

        cursor++;
        while (cursor < lines.length && lines[cursor].trim() !== 'END:VEVENT') {
          const l: string = lines[cursor].trim();
          if (l.startsWith('UID:')) {
            id = `${sourceId}-${l.substring(4).trim()}`;
          } else if (l.startsWith('SUMMARY:')) {
            title = l.substring(8).trim();
          } else if (l.startsWith('DESCRIPTION:')) {
            description = l.substring(12).trim();
          } else if (l.startsWith('DTSTART:')) {
            dtStart = this.parseIcsDate(l.substring(8).trim());
          } else if (l.startsWith('DTEND:')) {
            dtEnd = this.parseIcsDate(l.substring(6).trim());
          }
          cursor++;
        }

        if (title && title !== '') {
          const ev: CalendarEvent = {
            id: id,
            title: title,
            description: description,
            startTime: dtStart,
            endTime: dtEnd,
            allDay: false,
            source: sourceId,
            reminderMinutes: 0,
            reminded: true
          };
          imported.push(ev);
        }
      }
      cursor++;
    }

    if (imported.length > 0) {
      // å…ˆåˆ é™¤è¯¥è®¢é˜…æºçš„æ—§äº‹ä»¶
      const filtered: CalendarEvent[] = this.events.filter((e: CalendarEvent): boolean => e.source !== sourceId);
      this.events = filtered.concat(imported);
    }
  }

  private getEventsForDate(date: Date): CalendarEvent[] {
    const filtered: CalendarEvent[] = this.events.filter((e: CalendarEvent): boolean => this.isSameDate(e.startTime, date));
    // æŒ‰èµ·å§‹æ—¶é—´æ’åº
    filtered.sort((a: CalendarEvent, b: CalendarEvent): number => {
      return a.startTime.getTime() - b.startTime.getTime();
    });
    return filtered;
  }

  private countEventsForDate(date: Date): number {
    return this.getEventsForDate(date).length;
  }

  private getEventDotArray(date: Date): number[] {
    const count: number = this.countEventsForDate(date);
    // æœ‰äº‹ä»¶å°±æ˜¾ç¤º 1 ä¸ªç‚¹ï¼Œæ²¡æœ‰äº‹ä»¶å°±ä¸æ˜¾ç¤º
    if (count > 0) {
      return [0];
    }
    return [];
  }

  private formatTimeRange(e: CalendarEvent): string {
    if (e.allDay) {
      return 'å…¨å¤©';
    }
    const pad = (n: number): string => (n < 10 ? `0${n}` : `${n}`);
    const sh: number = e.startTime.getHours();
    const sm: number = e.startTime.getMinutes();
    const eh: number = e.endTime.getHours();
    const em: number = e.endTime.getMinutes();
    return `${pad(sh)}:${pad(sm)} - ${pad(eh)}:${pad(em)}`;
  }

  private getReminderSelectIndex(): number {
    const values: number[] = [0, 5, 15, 30, 60];
    const idx: number = values.indexOf(this.editingReminderMinutes);
    return idx >= 0 ? idx : 0;
  }

  private getReminderSelectValue(): string {
    const labels: string[] = ['ä¸æé†’', '5åˆ†é’Ÿ', '15åˆ†é’Ÿ', '30åˆ†é’Ÿ', '1å°æ—¶'];
    const idx: number = this.getReminderSelectIndex();
    return labels[idx];
  }

  private exportEventsToIcs(): string {
    let lines: string[] = [];
    lines.push('BEGIN:VCALENDAR');
    lines.push('VERSION:2.0');
    lines.push('PRODID:-//HarmonyCalendar//CN');

    const allEvents: CalendarEvent[] = this.events;
    for (let i: number = 0; i < allEvents.length; i++) {
      const e: CalendarEvent = allEvents[i];
      lines.push('BEGIN:VEVENT');
      lines.push(`UID:${e.id}`);
      lines.push(`SUMMARY:${e.title}`);
      if (e.description) {
        lines.push(`DESCRIPTION:${e.description}`);
      }
      lines.push(`DTSTART:${this.formatIcsDate(e.startTime)}`);
      lines.push(`DTEND:${this.formatIcsDate(e.endTime)}`);
      lines.push('END:VEVENT');
    }

    lines.push('END:VCALENDAR');
    return lines.join('\n');
  }

  private importEventsFromIcs(text: string) {
    if (!text || text.trim() === '') {
      return;
    }
    const lines: string[] = text.split('\n');
    let cursor: number = 0;
    let imported: CalendarEvent[] = [];

    while (cursor < lines.length) {
      const line: string = lines[cursor].trim();
      if (line === 'BEGIN:VEVENT') {
        let id: string = `${Date.now()}-${cursor}`;
        let title: string = '';
        let description: string = '';
        let dtStart: Date = new Date();
        let dtEnd: Date = new Date();

        cursor++;
        while (cursor < lines.length && lines[cursor].trim() !== 'END:VEVENT') {
          const l: string = lines[cursor].trim();
          if (l.startsWith('UID:')) {
            id = l.substring(4).trim();
          } else if (l.startsWith('SUMMARY:')) {
            title = l.substring(8).trim();
          } else if (l.startsWith('DESCRIPTION:')) {
            description = l.substring(12).trim();
          } else if (l.startsWith('DTSTART:')) {
            dtStart = this.parseIcsDate(l.substring(8).trim());
          } else if (l.startsWith('DTEND:')) {
            dtEnd = this.parseIcsDate(l.substring(6).trim());
          }
          cursor++;
        }

        if (title && title !== '') {
          const ev: CalendarEvent = {
            id: id,
            title: title,
            description: description,
            startTime: dtStart,
            endTime: dtEnd,
            allDay: false,
            source: 'imported'
          };
          imported.push(ev);
        }
      }
      cursor++;
    }

    if (imported.length > 0) {
      this.events = this.events.concat(imported);
    }
  }

  private formatIcsDate(d: Date): string {
    const pad = (n: number): string => (n < 10 ? `0${n}` : `${n}`);
    const year: number = d.getFullYear();
    const month: number = d.getMonth() + 1;
    const day: number = d.getDate();
    const hour: number = d.getHours();
    const minute: number = d.getMinutes();
    const second: number = d.getSeconds();
    return `${year}${pad(month)}${pad(day)}T${pad(hour)}${pad(minute)}${pad(second)}`;
  }

  private parseIcsDate(s: string): Date {
    // å½¢å¦‚ 20251211T090000
    if (!s || s.length < 15) {
      return new Date();
    }
    const year: number = Number.parseInt(s.substring(0, 4));
    const month: number = Number.parseInt(s.substring(4, 6));
    const day: number = Number.parseInt(s.substring(6, 8));
    const hour: number = Number.parseInt(s.substring(9, 11));
    const minute: number = Number.parseInt(s.substring(11, 13));
    const second: number = Number.parseInt(s.substring(13, 15));
    return new Date(year, month - 1, day, hour, minute, second);
  }

  private formatWeekDayLabel(d: Date): string {
    const weekIndex: number = d.getDay();
    const dayLabel: string = this.weekDays[weekIndex];
    const dayNum: number = d.getDate();
    return `å‘¨${dayLabel} ${dayNum}æ—¥`;
  }

  // ==== å†œå†è®¡ç®—ï¼ˆå…¬å†è½¬å†œå†ï¼Œ1900-2100 å¹´æœ‰æ•ˆï¼‰====

  private lunarInfo: number[] = [
    0x04bd8, 0x04ae0, 0x0a570, 0x054d5, 0x0d260, 0x0d950, 0x16554, 0x056a0, 0x09ad0, 0x055d2,
    0x04ae0, 0x0a5b6, 0x0a4d0, 0x0d250, 0x1d255, 0x0b540, 0x0d6a0, 0x0ada2, 0x095b0, 0x14977,
    0x04970, 0x0a4b0, 0x0b4b5, 0x06a50, 0x06d40, 0x1ab54, 0x02b60, 0x09570, 0x052f2, 0x04970,
    0x06566, 0x0d4a0, 0x0ea50, 0x06e95, 0x05ad0, 0x02b60, 0x186e3, 0x092e0, 0x1c8d7, 0x0c950,
    0x0d4a0, 0x1d8a6, 0x0b550, 0x056a0, 0x1a5b4, 0x025d0, 0x092d0, 0x0d2b2, 0x0a950, 0x0b557,
    0x06ca0, 0x0b550, 0x15355, 0x04da0, 0x0a5d0, 0x14573, 0x052d0, 0x0a9a8, 0x0e950, 0x06aa0,
    0x0aea6, 0x0ab50, 0x04b60, 0x0aae4, 0x0a570, 0x05260, 0x0f263, 0x0d950, 0x05b57, 0x056a0,
    0x096d0, 0x04dd5, 0x04ad0, 0x0a4d0, 0x0d4d4, 0x0d250, 0x0d558, 0x0b540, 0x0b5a0, 0x195a6,
    0x095b0, 0x049b0, 0x0a974, 0x0a4b0, 0x0b27a, 0x06a50, 0x06d40, 0x0af46, 0x0ab60, 0x09570,
    0x04af5, 0x04970, 0x064b0, 0x074a3, 0x0ea50, 0x06b58, 0x05ac0, 0x0ab60, 0x096d5, 0x092e0,
    0x0c960, 0x0d954, 0x0d4a0, 0x0da50, 0x07552, 0x056a0, 0x0abb7, 0x025d0, 0x092d0, 0x0cab5,
    0x0a950, 0x0b4a0, 0x0baa4, 0x0ad50, 0x055d9, 0x04ba0, 0x0a5b0, 0x15176, 0x052b0, 0x0a930,
    0x07954, 0x06aa0, 0x0ad50, 0x05b52, 0x04b60, 0x0a6e6, 0x0a4e0, 0x0d260, 0x0ea65, 0x0d530,
    0x05aa0, 0x076a3, 0x096d0, 0x04afb, 0x04ad0, 0x0a4d0, 0x1d0b6, 0x0d250, 0x0d520, 0x0dd45,
    0x0b5a0, 0x056d0, 0x055b2, 0x049b0, 0x0a577, 0x0a4b0, 0x0aa50, 0x1b255, 0x06d20, 0x0ada0,
    0x14b63
  ];

  private lunarMonthDays(year: number, month: number): number {
    const info = this.lunarInfo[year - 1900];
    return (info & (0x10000 >> month)) ? 30 : 29;
  }

  private leapMonth(year: number): number {
    return this.lunarInfo[year - 1900] & 0xf;
  }

  private leapMonthDays(year: number): number {
    const info = this.lunarInfo[year - 1900];
    if (this.leapMonth(year) !== 0) {
      return (info & 0x10000) ? 30 : 29;
    }
    return 0;
  }

  private solarToLunar(date: Date): LunarDateResult {
    const baseDate: Date = new Date(1900, 0, 31); // 1900-01-31 å¯¹åº”å†œå† 1900-æ­£æœˆåˆä¸€
    let offset: number = Math.floor((date.getTime() - baseDate.getTime()) / 86400000);

    let year: number = 1900;
    let temp: number = 0;

    while (year < 2101 && offset > 0) {
      temp = this.lunarYearDays(year);
      if (offset < temp) {
        break;
      }
      offset -= temp;
      year++;
    }

    let leap: number = this.leapMonth(year);
    let isLeap: boolean = false;
    let month: number = 1;

    while (month <= 12 && offset >= 0) {
      if (leap > 0 && month === leap + 1 && !isLeap) {
        month--;
        isLeap = true;
        temp = this.leapMonthDays(year);
      } else {
        temp = this.lunarMonthDays(year, month);
      }

      if (offset < temp) {
        break;
      }

      offset -= temp;

      if (isLeap && month === leap + 1) {
        isLeap = false;
      }
      month++;
    }

    const day: number = offset + 1;
    const result: LunarDateResult = { lunarYear: year, lunarMonth: month, lunarDay: day, isLeap: isLeap };
    return result;
  }

  private lunarYearDays(year: number): number {
    let sum: number = 348;
    const info: number = this.lunarInfo[year - 1900];
    for (let i = 0x8000; i > 0x8; i >>= 1) {
      sum += (info & i) ? 1 : 0;
    }
    return sum + this.leapMonthDays(year);
  }

  private getLunarLabel(d: Date): string {
    const lunar = this.solarToLunar(d);
    const day: number = lunar.lunarDay;

    // å†œå†æœˆä»½åç§°
    const monthNames: string[] = ['æ­£æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'å†¬æœˆ', 'è…Šæœˆ'];

    // æ¯æœˆåˆä¸€æ˜¾ç¤ºæœˆä»½ï¼ˆä¾‹å¦‚ï¼šå…­æœˆåˆä¸€ æ˜¾ç¤ºä¸º â€œå…­æœˆâ€ï¼Œé—°å…­æœˆåˆä¸€ æ˜¾ç¤ºä¸º â€œé—°å…­æœˆâ€ï¼‰
    if (day === 1) {
      const monthIndex: number = lunar.lunarMonth - 1;
      if (monthIndex >= 0 && monthIndex < monthNames.length) {
        const prefix: string = lunar.isLeap ? 'é—°' : '';
        return `${prefix}${monthNames[monthIndex]}`;
      }
    }

    const baseNames: string[] = ['åˆä¸€', 'åˆäºŒ', 'åˆä¸‰', 'åˆå››', 'åˆäº”', 'åˆå…­', 'åˆä¸ƒ', 'åˆå…«', 'åˆä¹', 'åˆå',
      'åä¸€', 'åäºŒ', 'åä¸‰', 'åå››', 'åäº”', 'åå…­', 'åä¸ƒ', 'åå…«', 'åä¹', 'äºŒå',
      'å»¿ä¸€', 'å»¿äºŒ', 'å»¿ä¸‰', 'å»¿å››', 'å»¿äº”', 'å»¿å…­', 'å»¿ä¸ƒ', 'å»¿å…«', 'å»¿ä¹', 'ä¸‰å'];
    if (day >= 1 && day <= baseNames.length) {
      return baseNames[day - 1];
    }
    return '';
  }

  private getMonthGridDates(): Date[] {
    let result: Date[] = [];
    let firstDay: Date = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), 1);
    let startWeekDay: number = firstDay.getDay();
    let dayCounter: number = 1 - startWeekDay;

    for (let i: number = 0; i < 42; i++) {
      result.push(new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), dayCounter));
      dayCounter++;
    }
    return result;
  }

  private getMonthCellDate(rowIndex: number, colIndex: number): Date {
    const monthCells: Date[] = this.getMonthGridDates();
    const idx: number = rowIndex * 7 + colIndex;
    return monthCells[idx];
  }

  private getWeekStartDate(): Date {
    const d: Date = this.currentDate;
    const day: number = d.getDay();
    // ä»¥å‘¨æ—¥ä¸ºä¸€å‘¨å¼€å§‹
    return new Date(d.getFullYear(), d.getMonth(), d.getDate() - day);
  }

  private getWeekCellDate(index: number): Date {
    const start: Date = this.getWeekStartDate();
    return new Date(start.getFullYear(), start.getMonth(), start.getDate() + index);
  }

  private isCellInCurrentMonth(rowIndex: number, colIndex: number): boolean {
    const d: Date = this.getMonthCellDate(rowIndex, colIndex);
    return d.getMonth() === this.currentDate.getMonth();
  }

  private isCellToday(rowIndex: number, colIndex: number): boolean {
    const d: Date = this.getMonthCellDate(rowIndex, colIndex);
    return this.isSameDate(d, new Date());
  }

  @Builder
  private buildWeekView() {
    Column() {
      // é¡¶éƒ¨ä¸€è¡Œæ˜¾ç¤ºæœ¬å‘¨ 7 å¤©ï¼ˆä»…æ—¥æœŸæ•°å­—ï¼Œå‘¨å‡ ç”±ä¸Šæ–¹æ˜ŸæœŸæ å±•ç¤ºï¼‰
      Row() {
        ForEach(this.weekIndices, (idx: number) => {
          Column() {
            Text(`${this.getWeekCellDate(idx).getDate()}`)
              .fontSize(14)
              .fontWeight(this.isSameDate(this.getWeekCellDate(idx), this.currentDate) ? FontWeight.Medium : FontWeight.Normal)
              .fontColor(this.isSameDate(this.getWeekCellDate(idx), this.currentDate) ? '#111827' : '#4B5563')
          }
          .width('14.28%')
          .height(44)
          .borderRadius(12)
          .backgroundColor(this.isSameDate(this.getWeekCellDate(idx), this.currentDate) ? '#E5EDFF' : 'transparent')
          .justifyContent(FlexAlign.Center)
          .alignItems(HorizontalAlign.Center)
          .onClick(() => {
            this.currentDate = this.getWeekCellDate(idx);
          })
        }, (idx: number) => `${idx}`)
      }
      .margin({ bottom: 12 })

      // æœ¬å‘¨äº‹ä»¶åˆ—è¡¨ï¼ˆæŒ‰å¤©æ’åˆ—ï¼Œç®€æ´åˆ—è¡¨æ ·å¼ï¼Œå¯æ»šåŠ¨ï¼‰
      Scroll() {
        Column() {
          ForEach(this.weekIndices, (idx: number) => {
            if (this.getEventsForDate(this.getWeekCellDate(idx)).length > 0) {
              Column() {
                // æ¯å¤©çš„å°æ ‡é¢˜
                Text(this.formatWeekDayLabel(this.getWeekCellDate(idx)))
                  .fontSize(13)
                  .fontColor('#6B7280')
                  .margin({ top: 4, bottom: 2 })

                // è¿™ä¸€å¤©çš„äº‹ä»¶åˆ—è¡¨
                Column() {
                  ForEach(this.getEventsForDate(this.getWeekCellDate(idx)), (event: CalendarEvent) => {
                    Row() {
                      // å·¦ä¾§æ—¶é—´åˆ—
                      Text(this.formatTimeRange(event))
                        .fontSize(13)
                        .fontColor('#6B7280')
                        .width(100)

                      // å³ä¾§äº‹ä»¶ä¿¡æ¯
                      Column() {
                        Text(event.title)
                          .fontSize(14)
                          .fontWeight(FontWeight.Medium)
                          .fontColor('#111827')
                          .maxLines(1)
                          .textOverflow({ overflow: TextOverflow.Ellipsis })
                          .width('100%')

                        if (event.description) {
                          Text(event.description)
                            .fontSize(12)
                            .fontColor('#6B7280')
                            .margin({ top: 2 })
                            .maxLines(1)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })
                            .width('100%')
                        }
                      }
                      .layoutWeight(1)
                      .alignItems(HorizontalAlign.Start)
                    }
                    .width('100%')
                    .padding({ left: 12, right: 12, top: 10, bottom: 10 })
                    .backgroundColor(Color.White)
                    .borderRadius(8)
                    .margin({ bottom: 8 })
                    .onClick(() => {
                      this.openEditEventEditor(event);
                    })
                  }, (event: CalendarEvent) => event.id)
                }
              }
              .margin({ bottom: 6 })
            }
          }, (idx: number) => `week-list-${idx}`)
        }
        .width('100%')
        .alignItems(HorizontalAlign.Start)
      }
      .height(500)
      .margin({ left: 16, right: 16 })
      .scrollBar(BarState.Off)
      .align(Alignment.TopStart)
    }
  }

  @Builder
  private buildDayView() {
    Column() {
      // é¡¶éƒ¨æ—¥æœŸè¯´æ˜
      Row() {
        Column() {
          Text(this.formatDateLabel(this.currentDate))
            .fontSize(15)
            .fontWeight(FontWeight.Medium)
            .fontColor('#111827')
          Text('å½“å¤©æ‰€æœ‰æ—¥ç¨‹')
            .fontSize(12)
            .fontColor('#6B7280')
            .margin({ top: 2 })
        }
      }
      .margin({ bottom: 12 })

      // å½“å¤©äº‹ä»¶åˆ—è¡¨ï¼ˆå¯æ»šåŠ¨ï¼‰
      Scroll() {
        Column() {
          if (this.getEventsForDate(this.currentDate).length === 0) {
            Text('è¿™ä¸€å¤©æš‚æ—¶è¿˜æ²¡æœ‰æ—¥ç¨‹')
              .fontSize(16)
              .fontColor('#4B5563')
              .textAlign(TextAlign.Center)
              .margin({ top: 24 })
          } else {
            ForEach(this.getEventsForDate(this.currentDate), (event: CalendarEvent) => {
              Row() {
                // å·¦ä¾§æ—¶é—´åˆ—
                Text(this.formatTimeRange(event))
                  .fontSize(13)
                  .fontColor('#6B7280')
                  .width(100)

                // å³ä¾§äº‹ä»¶ä¿¡æ¯
                Column() {
                  Text(event.title)
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#111827')
                    .width('100%')

                  if (event.description) {
                    Text(event.description)
                      .fontSize(13)
                      .fontColor('#6B7280')
                      .margin({ top: 2 })
                      .width('100%')
                  }
                }
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Start)
              }
              .width('100%')
              .padding({ left: 12, right: 12, top: 10, bottom: 10 })
              .backgroundColor(Color.White)
              .borderRadius(8)
              .margin({ bottom: 8 })
              .onClick(() => {
                this.openEditEventEditor(event);
              })
            }, (event: CalendarEvent) => `day-${event.id}-${event.title}-${event.startTime.getTime()}`)
          }
        }
        .width('100%')
        .alignItems(HorizontalAlign.Start)
      }
      .height(500)
      .margin({ left: 16, right: 16 })
      .scrollBar(BarState.Off)
      .align(Alignment.TopStart)
    }
  }

  private isSameDate(a: Date, b: Date): boolean {
    return a.getFullYear() === b.getFullYear() &&
      a.getMonth() === b.getMonth() &&
      a.getDate() === b.getDate();
  }

  private formatDateLabel(date: Date): string {
    const year = date.getFullYear();
    const month = date.getMonth() + 1;
    const day = date.getDate();
    const week = this.weekDays[date.getDay()];
    return `${year}å¹´${month}æœˆ${day}æ—¥ Â· å‘¨${week}`;
  }
}